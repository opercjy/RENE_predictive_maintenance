-----

# 통합 물리 센서 실시간 모니터링 시스템

**최종 수정일: 2025-08-12** **작성자: 최지영 (전남대학교 물리학과 / 전남대학교 중성미자 정밀 연구센터)**

## 개요

이 애플리케이션은 다양한 종류의 물리 센서(온도, 초음파 거리, 라돈, 자기장)로부터 데이터를 실시간으로 수집, 처리, 시각화 및 저장하는 통합 모니터링 솔루션입니다. 복잡한 하드웨어 제어와 데이터 처리를 다루면서도, 사용자가 직관적으로 시스템 상태를 파악할 수 있도록 설계되었습니다.

특히 각 하드웨어는 독립적인 백그라운드 스레드에서 제어되어, 데이터 수집 중에도 GUI의 응답성이 완벽하게 보장되는 안정적인 아키텍처를 채택했습니다.

## 주요 기능

  * **다중 센서 통합**: 온도(RTD), 초음파 거리, 라돈, 자기장 센서를 동시에 모니터링합니다 (이 예제에서만, 실제로는 더 많은 감시 센서 부착됨).
  * **실시간 데이터 시각화**: `pyqtgraph`를 활용하여 모든 센서 데이터를 실시간 그래프로 표시하며, 최대 7일간의 데이터를 추적합니다.
  * **안정적인 데이터 수집**: `QThread` 기반의 멀티스레딩 설계를 통해 각 하드웨어를 독립적으로 제어하여 GUI 멈춤 현상을 방지합니다.
  * **고급 신호 처리**:
      * **Oversampling & Averaging**: NI-DAQ의 고속 샘플링(1kHz)과 평균화 기법으로 저주파 센서의 노이즈를 효과적으로 제거합니다.
      * **전압-거리 변환**: SICK UM30 센서의 아날로그 전압 출력을 mm 단위의 물리적 거리로 실시간 변환하여 표시합니다.
  * **데이터베이스 연동**: `MariaDB` 커넥션 풀을 사용하여 수집된 데이터를 안정적으로 저장하고 관리합니다. (기본 비활성화)
  * **자동 하드웨어 감지**: 프로그램 시작 시 연결된 NI-DAQ, 시리얼 포트, VISA 장비를 자동으로 감지하여 사용 가능 여부를 판단합니다.

## 시스템 아키텍처

이 시스템은 **GUI 스레드**와 **워커 스레드**가 분리된 구조로 동작합니다.

  * **메인 GUI 스레드**: 사용자와의 상호작용, 데이터 표시, 그래프 업데이트 등 모든 시각적 요소를 담당합니다.
  * **워커 스레드**: 각 하드웨어(NI-DAQ, 라돈, 자기장)는 자신만의 독립된 백그라운드 스레드에서 동작합니다. 이들은 시간이 오래 걸리는 데이터 수집 작업을 전담하며, 수집된 데이터는 `pyqtSignal`을 통해 메인 GUI 스레드로 안전하게 전달됩니다.

<!-- end list -->

```
[ 메인 GUI 스레드 ]  <-- pyqtSignal -- [ NI-DAQ 워커 스레드 ]
(UI 업데이트)       (데이터 전송)       (고속 샘플링 및 처리)
                     <-- pyqtSignal -- [ 라돈 센서 워커 스레드 ]
                     (데이터 전송)       (시리얼 통신 및 대기)
                     <-- pyqtSignal -- [ 자기장 센서 워커 스레드 ]
                     (데이터 전송)       (VISA 통신)
```

## 하드웨어 요구사항

본 코드는 아래의 하드웨어를 기준으로 작성되었습니다.

  * **데이터 수집 장비 (DAQ)**: National Instruments **cDAQ** 섀시
      * 온도 모듈 (RTD, Pt100 센서 입력용)
      * 전압 모듈 (SICK 초음파 센서의 0-10V 아날로그 출력 입력용, 기타 전압 출력)
      * 전류 모듈 (SICK 초음파 센서의 0-20 mA 아날로그 출력 입력용, 기타 전류 출력)
  * **초음파 거리 센서**: **SICK UM30-213 계열** (0-10V 아날로그 출력)
  * **라돈 검출기**: **FRD400** 또는 **RS9A** 등 UART 시리얼 통신을 사용하는 모델
  * **자기장 센서**: **TFM1186** 등 NI-VISA 라이브러리를 통해 제어되는 모델

## 소프트웨어 준비 및 설치

1.  **필수 드라이버 설치**:

      * **NI-DAQmx**: National Instruments 홈페이지에서 최신 버전의 드라이버를 설치해야 합니다.
      * **NI-VISA**: 자기장 센서와의 통신을 위해 필요합니다.

2.  **Python 환경 설정**:

      * Python 3.8 이상 버전을 설치합니다.
      * 프로젝트 폴더에서 가상 환경을 생성하고 활성화하는 것을 강력히 권장합니다.
        ```bash
        python -m venv venv
        source venv/bin/activate  # Linux/Mac
        .\venv\Scripts\activate   # Windows
        ```

3.  **필요 라이브러리 설치**:
력
      * 아래 명령어를 사용하여 코드 실행에 필요한 모든 파이썬 라이브러리를 설치합니다.
        ```bash
        pip install numpy pyqt5 pyqtgraph nidaqmx pyserial pyvisa
        ```
      * 데이터베이스를 사용하려면 추가로 `mariadb` 라이브러리를 설치해야 합니다.
        ```bash
        pip install mariadb
        ```

## 설정 방법 (`CONFIG` 변수)

프로그램 실행 전, 코드 하단의 `if __name__ == '__main__':` 블록 안에 있는 `CONFIG` 사전을 사용자의 환경에 맞게 수정해야 합니다.

```python
CONFIG = {
    'daq': {
        'available': True, # NI-DAQ 연결 여부
        'rtd': {'device': 'cDAQ9189-2189707Mod2', 'channels': ['ai0', 'ai1']},
        'volt': {
            'device': 'cDAQ9189-2189707Mod1', 
            'channels': ['ai0'],
            'mapping': [
                # 0번 채널(ai0)은 0~10V를 400~1800mm로 변환
                {'volt_range': [0.0, 10.0], 'dist_range_mm': [400, 1800]},
            ]
        }
    },
    # ... (라돈, 자기장, DB 설정) ...
}
```

  * **`available`**: 각 장비의 사용 여부를 `True` / `False`로 설정합니다. 하드웨어 자동 감지 기능이 이 값을 덮어쓸 수 있습니다.
  * **`device`**: NI-MAX 등에서 확인한 DAQ 모듈의 정확한 이름을 입력합니다.
  * **`channels`**: 사용할 채널 목록을 리스트 형태로 입력합니다. (예: `['ai0', 'ai1']`)
  * **`mapping`**: **(중요)** 초음파 센서의 전압-거리 변환 설정을 담당합니다.
      * `volt_range`: 센서의 아날로그 출력 범위 (보통 `[0.0, 10.0]`).
      * `dist_range_mm`: 센서에 **물리적으로 티칭(Teach-in)한** 최소 및 최대 거리(mm). 이 값을 기준으로 거리를 계산합니다.
  * **`port` / `resource_name`**: 각 시리얼, VISA 장비의 포트 또는 리소스 이름을 정확히 입력합니다.

## 실행 방법

모든 설정이 완료되었으면 터미널에서 아래 명령어로 프로그램을 실행합니다.

```bash
python your_script_name.py
```

`Ctrl+C`를 누르면 모든 스레드가 안전하게 종료됩니다.

## 핵심 개념 해설

#### NI-DAQ: 고속 샘플링과 평균화 기법

SICK 초음파 센서는 응답 속도가 느려(약 8Hz) 1초에 8번의 '계단식' 신호를 출력합니다. 이 신호에는 전기적 노이즈나 액체 표면의 실제 출렁임이 섞여 있어 불안정하게 보일 수 있습니다.

이 문제를 해결하기 위해, NI 9215 DAQ의 빠른 속도(최대 100kS/s)를 활용하는 **Oversampling & Averaging** 기법을 적용했습니다.

1.  **고속 샘플링(Oversampling)**: DAQ가 1초에 1000번(`1kHz`)의 데이터를 매우 빠르게 읽어들여 노이즈까지 모두 캡처합니다.
2.  **평균화(Averaging)**: 1초 동안 수집된 1000개의 샘플 데이터의 **평균**을 계산합니다.
3.  **결과**: 노이즈는 서로 상쇄되고, 우리는 1초를 대표하는 매우 안정적이고 정밀한 값 하나를 얻게 됩니다.

이 기법은 코드 내 `DaqWorker` 클래스에 구현되어 있습니다.

#### 초음파 센서(SICK UM30) 거리 변환

센서가 출력하는 0\~10V의 아날로그 전압은 그 자체로는 의미가 적습니다. 우리는 이 전압 값을 실제 거리(mm)로 변환해야 합니다. `DaqWorker.convert_voltage_to_distance` 메서드는 이 변환을 수행하며, **선형 보간(Linear Interpolation)** 공식을 사용합니다.

이 공식이 정확하게 동작하려면, `CONFIG`의 `dist_range_mm` 값이 **사용자가 센서에 물리적으로 티칭한 값과 반드시 일치**해야 합니다. 예를 들어, 센서의 0V를 400mm에, 10V를 1800mm에 티칭했다면, CONFIG에도 동일하게 `[400, 1800]`으로 설정해야 합니다.
